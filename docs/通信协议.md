# 电气设备检测装置通信协议

|修订版本|	修订日期    |    修订内容                    |	修订人|
|  ---  |   ----       |      ---                       |  ---   |
| v0.1.1  |	2022-02-09 |	加入发信字符串最大长度限制	|张頔|
| v0.1  |	2022-02-08 |	初始版本，定义了下位机传回数据格式	|张頔|

    本通信协议包含一下几部分通信内容的规定：（1）蓝牙下位机向上位机传输的数据格式和涵盖的基本内容；（2）上位机向下位机发指令的内容及其基本格式；（3）待补充。

---

## 一、 下位机发信协议

### 1.1 数据格式

数据格式为一个`Json`结构，最外层为一个大括号，内部每个键后跟冒号，再跟键值，键值末端以**分号**结尾，全部键值用引号括起来。字典深度为`1`，即仅有最外层一个大括号。发信时构拟成一个完整的**字符串**来发送。

受限于ESP软硬件，最长一次发送字符串长度不得超过**600**，若超过六百应将字符串分两次发送，具体方案需要讨论。

### 1.2 数据内容

字典内包括时间戳，数据条数，条目名称，当前采样时间间隔，当前从机地址，若干具体数据等。下面对每一条详细说明。

表1 键名与键值数据类型对应及含义简要介绍

|键名|	键值类型|	含义|
|---:|   :---: |---   |
|current_millis|	unsigned long|	单片机内部时钟当期时间，单位毫秒|
info_num|	int|	包含数据条数
info_name|	string|	条目名称，用逗号隔开
period_millis|	unsigned long|	传感器采样时间间隔，单位毫秒
address|	string|	当前传回参数从机地址
temperature|	double|	温度
humidity|	double|	湿度
O3_concentration|	double|	臭氧浓度
O3_precision|	-|	臭氧数据的精度
NOx_concentration|	double|	氮氧化物浓度
NOx_precision|	-|	氮氧化物数据的精度
NH3_concentration|	double|	氨气浓度
NH3_precision|	-|	氨气数据精度

（1）时间戳 current_millis

- 即ESP32的毫秒当期时间，数据类型为`unsigned long`

（2）包含数据条数 info_num

- 即传回信息中包含数据条目的总数，用来辅助分割条目名称的字符串段，数据类型为`int`。

（3）条目名称 info_name

- 上述传回信息中包含所有数据条目的名称，即除上述前五条必须包含的条目以外，最后所提到的“若干数据”所包含的所有数据的名称。数据类型为`string`，不同名称之间用**逗号**隔开。

（4）当前采样时间间隔 period_millis

- 采样时间间隔，数据类型为`unsigned long`，推荐默认采样间隔时长为1 s

（5）地址 address

- 标记当前传回数据的从机的地址位，数据类型为`string`。在早期测试中，仅有一台从机工作，此地址位留给未来多台从机组网构建蓝牙mesh用。

（6）其他若干数据

- 本传感器检测的数据包括**氮氧化物浓度**、**臭氧浓度**、**氨气浓度**三种气体浓度，检测**浓度取值范围**和**精度**取决于传感器，传感器精度可调，因此均需要传回。

    1）温湿度传感器

    - 温湿度包括`温度（temperature）`和`湿度（humidity）`，均为`double`数据类型，小数位数不定，后续补充。

    2）臭氧

    - 包括`臭氧浓度（O3_concentration）`和`精度（O3_precision）`，浓度为`double`数据类型，精度可能为有效数字，后续补充。

    3）氮氧化物

    - 包括`氮氧化物浓度（NOx_concentration）`和`精度（NOx_precision）`，浓度为`double`数据类型。

    4）氨气

    - 包括`氨气浓度（NH3_concentration）`和`精度（NH3_precision）`，浓度为`double`。

#### **发信样例demo：**

```javascript
{
    current_millis:"123456";
    info_num:"2";
    info_name:"temperature,humidity";
    period_millis:"1000";
    address:"1";
    temperature:"22.0";
    humidity:"20.0";
}
```

### 1.3 接收超时设置

在上下位机接通后`3秒`内，下位机仍然未向上位机传输任何`json`格式数据，上位机应予以提示。
