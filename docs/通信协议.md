# 电气设备检测装置通信协议

|修订版本|	修订日期    |    修订内容                    |	修订人|
|  ---  |   ----       |      ---                       |  ---   |
| v0.2.6  |	2022-02-16 |	精简协议，去除i_name  |易才润|
| v0.2.5  |	2022-02-13 |	加入字节编码内容，明确时间间隔查询方式  |张頔|
| v0.2.4  |	2022-02-13 |	字节择掉时间间隔，加入查询命令  |张頔|
| v0.2.3  |	2022-02-13 |	上位机系统身份识别  |张頔|
| v0.2.2  |	2022-02-13 |	删去ESP时间戳，精简下发上，加地址位  |张頔|
| v0.2.1  |	2022-02-12 |	安卓端20字节待解决，及小改  |张頔|
| v0.2.0  |	2022-02-10 |	确定下发上内容并精简，补充上发下格式     |张頔|
| v0.1.6  |	2022-02-10 |	订正字典结构格式            	        |张頔|
| v0.1.5  |	2022-02-10 |	提出代码json格式错误，加入真实时间戳	|易才润|
| v0.1.2  |	2022-02-09 |	氮氧化物细分为一氧化氮和二氧化氮，精简名称	|张頔|
| v0.1.1  |	2022-02-09 |	加入发信字符串最大长度限制	|张頔|
| v0.1  |	2022-02-08 |	初始版本，定义了下位机传回数据格式	|张頔|

    本通信协议包含一下几部分通信内容的规定：
    
    （1）蓝牙下位机向上位机传输的数据格式和涵盖的基本内容；
    
    （2）上位机向下位机发指令的内容及其基本格式；
    
    （3）硬件内部通信。

---

## 一、 下位机发信协议

### 1.1 数据格式

数据格式为一个`Json`结构，最外层为一个大括号，内部每个键后跟冒号，再跟键值，键值末端以**逗号**结尾，最后一个键值无逗号结尾，全部键用引号括起来，键值若为包含多个子字符串的字符串数组则用**中括号**括起来，内部每个键用**引号**括起来，中间用**逗号**隔开，数字保留原始状态。字典深度为`1`，即仅有最外层一个大括号。发信时构拟成一个完整的**字符串**来发送。

受限于ESP软硬件，最长一次发送字符串长度不得超过**600**，若超过六百应将字符串分两次发送，目前确定在苹果端传输字符串不会超过这个数。**重要**安卓端微信小程序一次只能接收不超过**20**个字节的数据包，将以若干个字节的形式发送。

### 1.2 数据内容

字典内包括数据条数，条目名称，当前采样时间间隔，当前从机地址，若干具体数据等。

**特别说明**，组成`json`的字符串内，相应键必须严格与下列顺序一致，因为在传回的条目名称中，传感器的数量是与下表相同的顺序相叠加，分最基础的温湿度+氨气直到全部传感器。若赋予了某特定传感器但并未检测到连接，则会返回`-1`作为测量量。下面对每一条详细说明。

表1 键名与键值数据类型对应及含义简要介绍

|键名|	 键值类型|	含义|
|---:|  :---:   |---   |
i_num|	int|	        包含数据条数
i_name|	string|	        条目名称，用逗号隔开
p_mls|	unsigned long|	传感器采样时间间隔，单位毫秒
add |	int   |     	当前传回参数从机地址
temp|	float |	        温度
humi|	float |	        湿度
NH3 |	double|	        氨气浓度
O3  |	double|	        臭氧浓度
NO  |	double|	        氮氧化物浓度
NO2 |	double|	        氮氧化物浓度


（1）包含数据条数 i_num

- 即传回信息中包含数据条目的总数，用来辅助分割条目名称的字符串段，数据类型为`int`。


（2）当前采样时间间隔 p_mls

- 采样时间间隔，数据类型为`unsigned long`，推荐默认采样间隔时长为`1s`

（3）地址 add

- 标记当前传回数据的从机的地址位，数据类型为`string`。在早期测试中，仅有一台从机工作，此地址位留给未来多台从机组网构建蓝牙mesh用，长度为1个字节。

（4）其他若干数据

- 本传感器检测的数据包括**氮氧化物浓度**、**臭氧浓度**、**氨气浓度**三种气体浓度，检测**浓度取值范围**和**精度**取决于传感器。对于气体传感器，其检测精度均为0.1ppm。

    1）温湿度传感器

    - 温湿度包括`温度（temp）`和`湿度（humi）`，均为`float`数据类型，小数位数1位。

    2）臭氧

    - 包括`臭氧浓度（O3）`，浓度为`double`数据类型。

    3）一氧化氮

    - 包括`氮氧化物浓度（NO）`，浓度为`double`数据类型。

    4）二氧化氮

    - 包括`氮氧化物浓度（NO2）`，浓度为`double`数据类型。

    5）氨气

    - 包括`氨气浓度（NH3）`，浓度为`double`。

#### **发信样例demo：**

```javascript
{
    "i_num":2,
    "per_mls":1000,
    "add":1,
    "temp":22.0,
    "humi":20.0
}
```

上位机接收后会在其中加入`当地时间戳（time）`，如下所示:

```javascript
{
    "i_num":2,
    "p_mls":1000,
    "add":1,
    "temp":20.3,
    "humi":42,
    "time":"2022/2/10下午3:15:36"
}
```

### 1.3 类安卓纯字节格式

> 此部分有待讨论，mtu 理论上可行

由于微信提供API在安卓端每次只能接收`20`个字节的数据包，因此对协议重新组织，用单个字节或两个字节传递数据，同时数据的顺序严格与表格顺序相同。

表2 字节位数与项目对应

|键名|	 字节数  |	         含义       |
|---:|  :---:   |---                   |
i_num|	1       |	        包含数据条数
add |	1       |     	    当前传回参数的从机地址
temp|	2       |	        温度
humi|	2       |	        湿度
NH3 |	2       |	        氨气浓度
O3  |	2       |	        臭氧浓度
NO  |	2       |	        氮氧化物浓度
NO2 |	2       |	        氮氧化物浓度

（1）温湿度

- 对于温湿度，高字节为整数部分，低字节为小数部分，若为负数则两个都是`0`。

（2）气体传感器

- 高字节和低字节共同组成要传的数，收到之后再乘以分辨率`0.1ppm`

#### **发信样例demo：**

```C++
"2" "1" 0x17 0x02 0x0f 0x00 // 传回2条数据，地址位为1，温度为23.2，湿度为15.0
"3" "1" 0x00 0x00 0x00 0x00 0x01 0x01// 传回3条数据，地址位为1，温湿度传感器工作异常，氨气浓度25.7ppm = (1*256+1)*0.1
```

（3）时间间隔

对于时间间隔，传输的格式特别限定，传回数据数目为`1`，这时候就是时间间隔，数据位为当前的period_millis。

```C++
"11500" // 传回1条数据，地址位为1，时间间隔为500毫秒
"111000" // 同上，时间间隔为1000毫秒
```

### 1.4 接收超时设置

在上下位机接通后`3秒`内，下位机仍然未向上位机传输任何格式数据，上位机应予以提示。上位机连接下位机后应先向下位机告知自己身份，然后下位机才会开始回传数据。

## 二、上位机向下位机发信的协议

上位机向下位机发送的内容包括两种：（1）上位机向下位机发送指令，用以调整从传感器读数的采样间隔；（2）上位机应当告诉下位机自己是苹果系统还是（类）安卓系统。

### 2.1 命令格式

指令为一个`字符串`，在下位机上存储的格式为`std::string`。对于身份告知命令，使用T命令，文本数据为"AP"时为苹果，为"AN"时为（类）安卓。

### 2.2 命令内容

首位字符为一大写字母，表明指令类型；第二个字符为数字，取值`0~9`，表明操作的传感器对象；第三个字符为地址位，是一个数字，取值`0~9`；对于调整采样间隔的命令，若第四位为`0`，则表明这是一个小数，注意不包含**小数点**；对于查询命令，仅返回长整型数的采样间隔。

- 首位字母

    - `"P"`：调整采样间隔
    - `"T"`: 发送文本信息
    - `"Q"`: 查询命令
        - 特别的，对于查询命令，应当避免回信的时候与定期传回的传感器数据同时调用函数，引起冲突。
        - 查询命令规定长度为4位，最后一位占位无实际意义。

- 第二位数字

    - `0`:  无指定传感器
    - `1`:  氨气传感器
    - `2`:  臭氧传感器
    - `3`:  一氧化氮传感器
    - `4`:  二氧化氮传感器
    - `5`:  温湿度传感器

- 第三位

    - 地址位 当地址位为`0`时，表明是向所有下位机发送。

- 第四位
    
    若为`0`，则说明是小数，后续无**小数点**。

#### **发信demo：**

```C
"P0105"             // 将地址1的从机的采样间隔调整为0.5s
"T01HelloWorld!"    // 向地址为1的从机发送文本"HelloWorld!"
"T00AP"             // 我是苹果
"Q010"              // 向地址为1的从机询问当前采样时间间隔
```

## 三、硬件内部通信及全局变量说明

### 3.1 发信间隔与全局变量

在程序内定义的`period_millis`，是发信间隔，也是从传感器获取数值的最小间隔。

如使用DHT等慢速传感器，则最小通信时间为`2秒`，因此，发信间隔不一定是传感器的询问时间。同样，温湿度数据不需要频繁更新，因此，对于温湿度设置一系列的全局变量，通过全局变量分别记录DHT传感器读数和上一次传感器读取时间，当时间间隔大于至少`2秒`后，再进行读写操作。

目前对DHT11读写设定时间间隔是`3000`毫秒。

### 3.2 调用发信函数的冲突协调

定期上报和查询发信同时需要调用发信函数，因此将查询发信间隔的回信设定在发信后的`20ms`之后，并至少距离下一次定期上报差`20ms`。需要设定发信函数调用的全局状态位。
